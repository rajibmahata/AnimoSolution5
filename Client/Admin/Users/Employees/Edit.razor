@page "/admin/users/employees/edit/{UserId:int}"
@page "/admin/users/employees/{UserId:int}/{FullName}"
@using Model.Shared.Entities
@inject IRepository repo
@inject IMostrarMensajes mostrar
@inject NavigationManager nm


<div id="headerSection">
    <div class="grid50l-- vtop">
        <h5>Firma Edition</h5>
        <hr class="hr4" />
        <div class="hh-40 vtop">
            <p class="p12 colorDarkGrey">Edit your record here</p>
        </div>
    </div>

    <div class="grid50r-- vtop">
        <h5>Options</h5>
        <hr class="hr4inverted" />
        <div class="hh-40 vtop">
            <GoBack></GoBack>
        </div>
    </div>
</div>


@if (paises.Count < 1)
{
    <LoadingAsset />
}
else
{
    <EditEmployeesForm users="user" OnValidSubmit="HandleEdit" paises="paises" firmas="firmas" roles="roles" />
}



@code {

    [Parameter] public int UserId { get; set; }
    [Parameter] public string FullName { get; set; }

    public List<Landes> paises = new List<Landes>();
    public List<Roles> roles = new List<Roles>();
    public List<Firmas> firmas = new List<Firmas>();

    Users user = new Users();


    protected async override Task OnInitializedAsync()
    {
        await LoadData();

        var httpResponse = await repo.Get<Users>($"api/users/{UserId}");

        if (httpResponse.Error)
        {
            if (httpResponse.HttpResponseMessage.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                nm.NavigateTo("admin");
            }
            else
            {
                await mostrar.MostrarMensajeError(await httpResponse.GetBody());
            }
        }
        else
        {
            user = httpResponse.Response;
        }

    }

    private async Task HandleEdit()
    {
        var httpResponse = await repo.Put("api/users", user);

        if (httpResponse.Error)
        {
            await mostrar.MostrarMensajeError(await httpResponse.GetBody());
        }
        else
        {
            Console.WriteLine("Before redirection");
            nm.NavigateTo("admin/users/employees");
        }
    }

    private async Task LoadData()
    {
        var ResponsePaises = await repo.Get<List<Landes>>("api/landes");
        paises = ResponsePaises.Response;

        var ResponseRoles = await repo.Get<List<Roles>>("api/roles");
        roles = ResponseRoles.Response;

        var ResponseFirmas = await repo.Get<List<Firmas>>("api/firmas");
        firmas = ResponseFirmas.Response;
    }

}
